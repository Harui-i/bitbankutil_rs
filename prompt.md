このプロジェクトはbitbankという仮想柄取引所用のRustライブラリプロジェクトです。

その他の情報は `AGENTS.md`を参照してください。

バックテスト機能を実施してください。

要件は以下のとおりです。

# 要件
## JSONLines形式のWebSocket通信データを入力とする

このプロジェクトでは、WebSocket通信をよく使います。そのため、バックテストもWebSocketで受信した記録のデータをもとに行う形式にしたいです。

入力として与えるデータのサンプルとして、 `/home/harui/rustlangs/bitbankutil_rs/bitbank_exec_book_xrp_jpy_v2_20251014.txt` を参照してみてください。

```
{"data_depth_whole_xrp_jpy":{"ask_market":"0","asks":[["371.030","600.4"],["371.199","772.9276"],["371.205","417.559"],["371.300","2000"],["371.302","200"],["371.337","10700"],["371.350","200"],["371.372","200"],["371.381","200"],["371.388","5984.8723"],["371.405","200"],["371.411","600"],["371.476","24719.0607"],["371.500","298.1865"],["371.509","200"],["371.536","4017.0244"],["371.555","100"],["371.558","1904.7619"],["371.647","25803.7308"],["371.852","100"],["371.999","30.0000"],["372.000","10.0000"],["372.278","4.4819"],["372.499","5369.1419"],["372.500","100.0000"],["372.514","8.7830"],["372.601","13.9760"],["372.764","27876"],["373.460","10.1000"],["374.016","16.5176"],["374.488","440"],["374.489","4200.3687"],["374.693","12.2778"],["374.769","45.0119"],["374.792","0.7000"],["374.882","350.9472"],["375.000","1177.6401"],["375.039","25.7785"],["375.043","713.1639"],["375.105","953.8366"],["375.111","2.2816"],["375.253","22.0000"],["375.390","4.2360"],["375.500","5.0000"],["375.949","0.1139"],["376.100","3000.0000"],["376.187","4.4150"],["376.199","1872.6060"],["376.422","2773.8600"],["376.491","6.2309"],["376.631","6.2463"],["376.865","1.1560"],["377.000","251.9311"],["377.050","500.0000"],["377.195","16.2476"],["377.312","270.0000"],["377.371","25922.1138"],["377.499","93.7961"],["378.000","26889.0318"],["378.138","9.5000"],["378.571","2.6679"],["378.627","12.0966"],["378.705","44.3399"],["378.977","25.5195"],["379.050","2.2828"],["379.278","9.7640"],["379.307","3.0210"],["379.308","16.9850"],["379.740","875.0000"],["379.900","33638.4410"],["379.912","0.7000"],["379.988","400.0000"],["379.999","102.6059"],["380.000","12766.8059"],["380.137","4.4383"],["380.401","16.2606"],["380.444","6.1395"],["380.561","9.4000"],["380.586","6.1547"],["380.700","1500.0000"],["380.820","0.7000"],["380.822","1.1599"],["380.944","2.6513"],["380.999","4.3436"],["381.000","320.0000"],["381.229","2.6493"],["381.234","0.7000"],["381.480","20.0446"],["381.505","0.0903"],["381.697","5.7480"],["382.020","0.7000"],["382.603","12.1023"],["382.681","44.3573"],["382.956","25.5259"],["382.971","2363.6470"],["383.030","2.2835"],["383.198","3576.5430"],["383.447","9.3000"],["383.480","22.0000"],["383.500","5.0000"],["383.550","500.0000"],["383.635","16.2669"],["383.779","9.3000"],["383.789","1000.0000"],["384.000","620.0000"],["384.106","3.1397"],["384.128","4.4200"],["384.200","130.0000"],["384.406","3.7692"],["384.439","6.1419"],["384.582","6.1572"],["384.706","3.5904"],["384.821","1.1619"],["384.899","10000"],["384.900","21506.5444"],["384.987","102.6059"],["385.000","2400.0520"],["385.006","3.9353"],["385.111","852.0130"],["385.135","9.3000"],["385.306","3.2988"],["385.500","350.0000"],["385.606","3.4225"],["385.880","22.0000"],["385.894","0.6710"],["385.906","4.3418"],["386.000","760.3751"],["386.150","5.0000"],["386.169","9.3000"],["386.500","350.0000"],["386.602","0.7000"],["386.621","12.1086"],["386.699","43.4416"],["386.818","18.3200"],["386.829","2.6110"],["386.860","10.5390"],["386.896","16.0676"],["386.977","24.9986"],["387.000","370.0000"],["387.051","2.2364"],["387.480","22.0000"],["387.500","350.0000"],["388.000","361.2042"],["388.162","4.4226"],["388.475","6.0162"],["388.500","5.0000"],["388.568","6.0490"],["388.619","0.1736"],["388.620","6.0633"],["388.700","1500.0000"],["388.861","1.1394"],["389.000","984.2040"],["389.064","3686.5591"],["389.219","5.4243"],["389.480","22.0000"],["389.900","94.4812"],["389.988","400.0000"],["390.000","12806.8570"],["390.052","1000.0000"],["390.184","16.0738"],["390.411","9.2000"],["390.554","2549.4310"],["390.680","11.8598"],["390.759","43.4560"],["390.785","3857.4220"],["391.000","1195.7630"],["391.042","25.0025"],["391.116","2.2369"],["391.480","22.0000"],["391.500","5.0000"],["391.764","0.6000"],["392.000","160.0000"],["392.237","4.3331"],["392.300","89.5000"],["392.554","6.0183"],["392.617","0.1736"],["392.701","6.0657"],["392.944","1.1414"],["392.986","1342.0496"],["393.000","20.0000"],["393.456","225.4203"],["393.480","22.0000"],["393.500","8.0000"],["393.501","16.0798"],["393.860","76.5800"],["393.899","6.8571"],["394.000","10.1644"],["394.023","2.5633"],["394.500","0.0634"],["394.782","11.8649"],["394.799","6.6100"],["394.862","43.9333"],["394.999","119.1858"],["395.000","2984.0033"],["395.099","4.9490"],["395.100","912.4727"]],"asks_over":"15100604.0586","asks_under":"0","bid_market":"0","bids":[["371.029","19882.0293"],["371.020","33.1244"],["371.003","1544.3118"],["370.999","190.0702"],["370.994","200"],["370.853","100"],["370.828","4017.0244"],["370.801","17600"],["370.785","100"],["370.770","79.5238"],["370.738","0.1346"],["370.726","73.5881"],["370.722","5010"],["370.706","5400"],["370.701","43.8147"],["370.699","10700"],["370.685","78.6084"],["370.679","7600"],["370.676","536.2708"],["370.675","9.4000"],["370.600","13.7000"],["370.563","313.1965"],["370.508","440"],["370.507","178.5878"],["370.393","5399.6701"],["370.201","30"],["370.200","10.6746"],["370.151","11.2103"],["370.111","0.7000"],["370.000","20093.9280"],["369.850","405.9857"],["369.843","25926.7869"],["369.820","154.2745"],["369.728","25298.82"],["369.691","10000"],["369.656","2"],["369.500","12.5000"],["369.400","3000.0000"],["369.379","4.1000"],["369.300","6778.4235"],["369.000","607.0660"],["368.962","4.2000"],["368.900","945.3231"],["368.235","10000.0000"],["368.000","4154.0475"],["367.323","200.0000"],["367.000","782.0580"],["366.454","4.2470"],["366.095","2931.6380"],["366.000","4728.2821"],["365.531","2028.5230"],["365.149","10000.0000"],["365.121","20000.0000"],["365.001","25.0000"],["365.000","1695.4685"],["364.837","0.0698"],["364.585","274.2844"],["364.508","0.4000"],["364.500","2539.0362"],["364.300","104.0000"],["364.222","2.0000"],["364.200","5000.0000"],["364.100","115.7364"],["364.000","1314.4160"],["363.832","4873.6807"],["363.793","250.0000"],["363.539","2.2022"],["363.521","276.2976"],["363.500","0.5238"],["363.469","24.8001"],["363.420","34.0000"],["363.400","137.4245"],["363.300","10000.0000"],["363.208","41.8555"],["363.134","11.2951"],["363.100","100.0000"],["363.000","815.1000"],["362.750","10.5000"],["362.570","3.7319"],["362.363","13.2644"],["362.300","96.5000"],["362.254","275.7184"],["362.180","5.2508"],["362.110","86.1963"],["362.100","232.6187"],["362.028","14.0780"],["362.000","12093.9342"],["361.819","90.7161"],["361.800","200.0000"],["361.732","5.5223"],["361.565","15.2597"],["361.500","10000.0000"],["361.444","0.7952"],["361.421","414.5310"],["361.269","8.2590"],["361.220","5.8202"],["361.085","5.8518"],["361.000","2933.3308"],["360.793","4.0180"],["360.736","13.4168"],["360.700","13.8453"],["360.600","10100.0000"],["360.555","194.0033"],["360.405","1.3856"],["360.336","55.4372"],["360.298","6.0880"],["360.216","10.0000"],["360.200","50.0000"],["360.107","1.3768"],["360.101","832.6010"],["360.100","5547.3559"],["360.003","66.4554"],["360.001","20500"],["360.000","87760.7988"],["359.777","610.7569"],["359.761","2.2359"],["359.692","25.1799"],["359.505","3812.1930"],["359.497","55.9795"],["359.434","42.4810"],["359.361","11.4627"],["359.281","0.0956"],["359.068","0.0362"],["359.000","1294.9892"],["358.951","2521.8290"],["358.800","278.3727"],["358.518","15.2338"],["358.500","53.0000"],["358.301","1000.0000"],["358.112","1143.8727"],["358.056","14.2503"],["358.000","44416.6601"],["357.844","5.0000"],["357.688","0.8035"],["357.600","100.0000"],["357.500","3278.1594"],["357.466","5.9082"],["357.333","5.9411"],["357.100","38.0000"],["357.044","4.0766"],["357.000","1579.9771"],["356.800","99.0485"],["356.440","500.0000"],["356.400","200.0000"],["356.120","5.0000"],["356.023","2.2593"],["356.010","8870.6193"],["356.001","66.0000"],["356.000","23574.2600"],["355.956","25.4442"],["355.896","357.8524"],["355.794","0.7413"],["355.699","42.9271"],["355.627","11.5830"],["355.511","18.1230"],["355.500","1520.0000"],["355.496","15.6345"],["355.400","84.6691"],["355.216","40.0000"],["355.200","100.0000"],["355.100","281.2732"],["355.001","500.0000"],["355.000","38330.1573"],["354.995","56.2712"],["354.888","80.2820"],["354.826","10.2510"],["354.700","281.5904"],["354.190","1.4099"],["354.000","1007.6204"],["353.971","0.8119"],["353.813","6.6430"],["353.752","5.9702"],["353.620","6.0035"],["353.600","3.0000"],["353.498","56.5095"],["353.334","4.2255"],["353.123","143.1754"],["353.072","49.9984"],["353.000","4390.6898"],["352.950","2832.3355"],["352.880","500.0000"],["352.800","14.1553"],["352.776","130.6019"],["352.600","1.0000"],["352.500","15.7674"],["352.397","0.1914"],["352.387","4277.8090"],["352.323","2.2524"],["352.300","99.0000"],["352.257","24.9648"],["352.100","10.0000"],["352.059","0.6051"],["352.046","332.0133"],["352.003","41.6027"],["352.000","10158.9046"],["351.931","12.0651"],["351.844","2829.7640"],["351.203","200.0000"]],"bids_over":"0","bids_under":"56250936.6163","sequenceId":"28292922181","timestamp":1760451084621},"exchange":"bitbank","received_at_micros":1760451084992301,"room_name":"depth_whole_xrp_jpy"}
{"data_depth_diff_xrp_jpy":{"a":[["371.530","4017.0244"],["371.302","0"],["371.350","0"],["371.381","0"],["371.536","0"],["371.523","0"],["384.899","15407.3948"],["371.509","0"],["371.405","0"],["371.378","210"],["371.274","114.4872"],["371.326","200"],["371.278","200"],["371.311","200"],["371.492","4017.0244"],["371.271","200"],["371.364","200"],["371.372","0"],["371.411","0"],["371.298","1299"]],"ao":"15100604.0586","b":[["370.001","440"],["371.020","0"],["370.508","0"],["370.994","0"],["371.029","15752.7328"],["370.997","200"],["371.007","33.1244"],["371.021","200"],["370.967","200"],["370.722","0"],["370.801","0"],["370.706","0"],["370.894","200"],["370.884","200"],["370.853","0"],["370.679","0"],["370.999","0"],["370.699","0"],["371.003","0"]],"bu":"56250936.6163","s":"28292922315","t":1760451084984},"exchange":"bitbank","received_at_micros":1760451084998243,"room_name":"depth_diff_xrp_jpy"}
```

のように、受信したデータに加えて、 `exchange` や `received_at_micros` や `room_name` といった情報も含んでいます。

これらのデータ収集は、以下のようなプログラムから行われました

```rust
use chrono::Local;
use crypto_botters::generic_api_client::websocket::WebSocketConfig;
use crypto_botters::{bitbank::BitbankOption, Client};
use log::LevelFilter;
use std::env;
use std::fs::OpenOptions;
use std::io::Write;
use std::time::Duration;

#[tokio::main]
async fn main() {
    // Set up logging
    env_logger::builder()
        .filter_level(LevelFilter::Debug)
        .init();

    // Bitbank client
    let bb_client = Client::new();
    let args: Vec<String> = env::args().collect();

    if args.len() != 3 {
        println!("arguments: {:?}", args);
        panic!("there should be two arguments; dir_path and pair_name");
    }

    let dir_path = args[1].clone();
    let pair_name = args[2].clone();

    // Closure to handle incoming websocket messages
    let bb_closure = {
        let pair_name = pair_name.clone();
        move |message: serde_json::Value| {
            let message_data: serde_json::Value =
                serde_json::from_value(message[1].clone()).expect("Failed to parse message data");

            log::debug!("message: {:?}", message_data.to_string());
            let now = Local::now();
            let room_name = message_data["room_name"].to_string().replace("\"", "");
            let new_val = serde_json::json!({
                format!("data_{}", room_name): message_data["message"]["data"],
                "room_name": room_name,
                "received_at_micros": now.timestamp_micros(),
                "exchange": "bitbank",
            });
            let file_name = format!(
                "{}/bitbank_exec_book_{}_v2_{}.txt",
                dir_path,
                pair_name,
                now.format("%Y%m%d")
            );

            let mut file = OpenOptions::new()
                .create(true)
                .append(true)
                .open(file_name)
                .expect("failed to open file");

            writeln!(file, "{}", new_val.to_string()).expect("failed to write file");
        }
    };

    // refresh after 4 hours
    let mut wsc: WebSocketConfig = WebSocketConfig::default();
    wsc.refresh_after = Duration::from_secs(4 * 3600);

    // Connect to the Bitbank websocket
    #[allow(unused_variables)]
    let bb_connection = bb_client
        .websocket(
            "",
            bb_closure,
            [
                BitbankOption::WebSocketChannels(vec![
                    format!("transactions_{}", pair_name).to_owned(),
                    format!("depth_diff_{}", pair_name).to_owned(),
                    format!("depth_whole_{}", pair_name).to_owned(),
                ]),
                BitbankOption::WebSocketConfig(wsc),
            ],
        )
        .await
        .expect("Failed to connect bitbank websocket");

    // Receive messages for a certain duration
    loop {
        tokio::time::sleep(Duration::from_secs(30)).await;
    }
}
```

こういったデータをもとに、バックテストを行えることがひとつの要件です。

## できるだけ、実運用プログラムと、バックテスト用プログラムの書き方や必要な部分の差分は少ない

もちろん実運用とバックテスト用の処理は違う部分が多くあります。しかし、多くの部分が共通化していたり、かき分ける部分が少ないほど望ましいです。

## best_mm.rs　のバックテストができる

best_mm.rsは、取引プログラムとして基本的な要素を含んでいます。そのため、このプログラムをバックテストできることが要件です


## バックテストの結果を出せる

取引数 / 損益 / 注文数 / Max DD といった結果を表示できる

## APIレートを模倣できる

API呼び出し制限を模倣できると嬉しいです


## できれば、高速である

バックテストが遅すぎると困ります。少なくとも、実際に取引する場合の100x ~ 1000xくらいは速くあってほしいです。

## できれば、API通信の遅延を再現できる

できれば嬉しいです。



要件は以上です。


# お願い

実装していくなかで、入力形式では足りない情報などがあれば、適宜フィードバックしてください。入力サイドを変えることも場合によっては可能です。

また、不明な点があれば、明確にするような質問をしても構いません。
